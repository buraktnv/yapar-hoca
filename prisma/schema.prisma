// Prisma schema for a basic education blog with Posts and Categories
// Provider: PostgreSQL (Supabase)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
}

enum QuizQuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  FILL_IN_BLANK
}

model User {
  id              String           @id @default(uuid())
  email           String           @unique
  name            String?
  role            UserRole         @default(USER)
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  posts           Post[]
  notes           Note[]           @relation("StudentNotes")
  createdNotes    Note[]           @relation("CreatedNotes")
  grades          Grade[]          @relation("StudentGrades")
  createdGrades   Grade[]          @relation("CreatedGrades")
  quizSubmissions QuizSubmission[]

  @@index([email])
}

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  order       Int        @default(0)
  parentId    String?
  parent      Category?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: Cascade)
  children    Category[] @relation("CategoryTree")
  posts       Post[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([slug])
  @@index([parentId])
  @@index([order])
}

model Note {
  id          String   @id @default(cuid())
  title       String
  content     String
  userId      String
  user        User     @relation("StudentNotes", fields: [userId], references: [id], onDelete: Cascade)
  createdById String
  createdBy   User     @relation("CreatedNotes", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([createdById])
}

model Grade {
  id          String   @id @default(cuid())
  testName    String
  subject     String
  score       Float
  maxScore    Float
  date        DateTime
  userId      String
  user        User     @relation("StudentGrades", fields: [userId], references: [id], onDelete: Cascade)
  createdById String
  createdBy   User     @relation("CreatedGrades", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([createdById])
  @@index([date])
}

model Post {
  id             String         @id @default(cuid())
  title          String
  slug           String         @unique
  excerpt        String?
  content        String
  featuredImage  String?
  published      Boolean        @default(false)
  publishedAt    DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  authorId       String
  author         User           @relation(fields: [authorId], references: [id], onDelete: Cascade)
  categories     Category[]
  featuredIn     FeaturedPost[]
  quizzes        Quiz[]

  @@index([slug])
  @@index([authorId])
  @@index([published])
  @@index([publishedAt])
}

// Implicit many-to-many relation table will be generated by Prisma

model Notification {
  id        String    @id @default(cuid())
  title     String
  content   String    // Rich HTML from TinyMCE
  bgColor   String?   // Background color hex
  isActive  Boolean   @default(false)
  startDate DateTime?
  endDate   DateTime?
  order     Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([isActive])
  @@index([order])
}

model HeroSlide {
  id        String   @id @default(cuid())
  title     String
  content   String?  // Optional text content
  image     String?  // Optional image URL
  linkUrl   String?  // Optional link
  bgColor   String?
  isActive  Boolean  @default(true)
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([order])
}

model Banner {
  id          String   @id @default(cuid())
  title       String
  content     String?  // Optional text
  image       String?  // Optional image URL
  linkUrl     String?  // Optional link
  isClickable Boolean  @default(false)
  layout      String   @default("slider") // "slider" or "grid"
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([order])
}

model FeaturedPost {
  id        String   @id @default(cuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  order     Int      @default(0)
  createdAt DateTime @default(now())

  @@index([postId])
  @@index([order])
}

model Quiz {
  id          String           @id @default(cuid())
  title       String
  description String?
  postId      String?          // Optional: attach to a post
  post        Post?            @relation(fields: [postId], references: [id], onDelete: Cascade)
  isActive    Boolean          @default(true)
  showAnswers Boolean          @default(false) // Show correct answers after submission
  trackScores Boolean          @default(true) // Track student scores
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  questions   QuizQuestion[]
  submissions QuizSubmission[]

  @@index([postId])
  @@index([isActive])
}

model QuizQuestion {
  id            String           @id @default(cuid())
  quizId        String
  quiz          Quiz             @relation(fields: [quizId], references: [id], onDelete: Cascade)
  question      String
  type          QuizQuestionType @default(MULTIPLE_CHOICE)
  options       String[] // JSON array for multiple choice
  correctAnswer String // Correct answer(s)
  order         Int              @default(0)
  points        Int              @default(1)
  createdAt     DateTime         @default(now())

  @@index([quizId])
  @@index([order])
}

model QuizSubmission {
  id        String   @id @default(cuid())
  quizId    String
  quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  userId    String?  // Null if anonymous
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  answers   Json     // Store user answers
  score     Float
  maxScore  Float
  createdAt DateTime @default(now())

  @@index([quizId])
  @@index([userId])
  @@index([createdAt])
}


